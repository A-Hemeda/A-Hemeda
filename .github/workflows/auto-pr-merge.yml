name: Auto PR and Merge

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

jobs:
  create_and_merge_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --local user.email "7hemeda@gmail.com"
          git config --local user.name "A-Hemeda"

      - name: Create feature branch
        run: |
          BRANCH="auto-merge-$(date '+%Y%m%d-%H%M%S')"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git checkout -b "$BRANCH"
          echo "Auto PR at $(date '+%Y-%m-%d %H:%M:%S')" >> LAST_UPDATED
          git add LAST_UPDATED
          git commit --author="A-Hemeda <7hemeda@gmail.com>" -m "Auto PR update - $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin "$BRANCH"

      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MY_PERSONAL_TOKEN }}
          script: |
            const branch = process.env.BRANCH;
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Auto PR: ${new Date().toISOString()}`,
              body: 'Automatic pull request created by workflow',
              head: branch,
              base: 'main',
              maintainer_can_modify: true
            });
            core.exportVariable('PR_NUMBER', pr.data.number);
        env:
          GIT_AUTHOR_NAME: A-Hemeda
          GIT_AUTHOR_EMAIL: 7hemeda@gmail.com
          GIT_COMMITTER_NAME: A-Hemeda
          GIT_COMMITTER_EMAIL: 7hemeda@gmail.com

      - name: Auto merge Pull Request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MY_PERSONAL_TOKEN }}
          script: |
            const prNumber = process.env.PR_NUMBER || '${{ github.event.pull_request.number }}';
            if (prNumber) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber),
                merge_method: 'squash'
              });
            }
